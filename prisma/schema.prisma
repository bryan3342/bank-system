generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// USERS
// ============================================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String
  password      String   // hashed with bcrypt
  walletBalance Decimal  @default(0) @map("wallet_balance") @db.Decimal(12, 4)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Location tracking
  lastLatitude   Decimal?  @map("last_latitude") @db.Decimal(10, 7)
  lastLongitude  Decimal?  @map("last_longitude") @db.Decimal(10, 7)
  lastLocationAt DateTime? @map("last_location_at")
  isNearOthers   Boolean   @default(false) @map("is_near_others")

  // Relations
  ownedGroups    Group[]         @relation("GroupOwner")
  memberships    GroupMember[]
  joinRequests   JoinRequest[]
  createdEvents  Event[]         @relation("EventCreator")
  checkins       EventCheckin[]
  transactions   Transaction[]

  @@index([lastLocationAt])
  @@map("users")
}

// ============================================================
// GROUPS
// ============================================================

model Group {
  id            String   @id @default(uuid())
  name          String   @db.VarChar(100)
  description   String?
  inviteCode    String   @unique @map("invite_code") @db.VarChar(20)
  ownerId       String   @map("owner_id")
  currencyRate  Decimal  @default(1.0000) @map("currency_rate") @db.Decimal(10, 4) // Grub per minute
  minAttendance Int      @default(2) @map("min_attendance")
  avatarUrl     String?  @map("avatar_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  owner        User          @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members      GroupMember[]
  joinRequests JoinRequest[]
  events       Event[]

  @@index([inviteCode])
  @@index([ownerId])
  @@map("groups")
}

model GroupMember {
  id       String   @id @default(uuid())
  groupId  String   @map("group_id")
  userId   String   @map("user_id")
  role     String   @default("member") @db.VarChar(20) // owner, admin, member
  joinedAt DateTime @default(now()) @map("joined_at")

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("group_members")
}

// ============================================================
// JOIN REQUESTS
// ============================================================

model JoinRequest {
  id        String   @id @default(uuid())
  groupId   String   @map("group_id")
  userId    String   @map("user_id")
  status    String   @default("pending") @db.VarChar(20) // pending, approved, denied
  token     String   @unique @db.VarChar(64) // for email approval links
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@index([token])
  @@map("join_requests")
}

// ============================================================
// EVENTS
// ============================================================

model Event {
  id            String    @id @default(uuid())
  groupId       String    @map("group_id")
  name          String    @db.VarChar(200)
  description   String?
  latitude      Decimal   @db.Decimal(10, 7)
  longitude     Decimal   @db.Decimal(10, 7)
  radiusMeters  Int       @default(100) @map("radius_meters")
  startsAt      DateTime  @map("starts_at")
  endsAt        DateTime  @map("ends_at")
  minAttendance Int?      @map("min_attendance") // null = use group default
  currencyRate  Decimal?  @map("currency_rate") @db.Decimal(10, 4) // null = use group default
  status        String    @default("scheduled") @db.VarChar(20) // scheduled, active, confirmed, ended, cancelled
  confirmedAt   DateTime? @map("confirmed_at")
  createdBy     String    @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  group    Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  creator  User           @relation("EventCreator", fields: [createdBy], references: [id])
  checkins EventCheckin[]

  @@index([groupId])
  @@index([status])
  @@index([startsAt, endsAt])
  @@map("events")
}

// ============================================================
// EVENT CHECK-INS
// ============================================================

model EventCheckin {
  id                  String    @id @default(uuid())
  eventId             String    @map("event_id")
  userId              String    @map("user_id")
  checkedInAt         DateTime  @default(now()) @map("checked_in_at")
  checkedOutAt        DateTime? @map("checked_out_at")
  lastLocationPing    DateTime? @map("last_location_ping")
  isWithinRadius      Boolean   @default(false) @map("is_within_radius")
  totalSecondsPresent Int       @default(0) @map("total_seconds_present")
  currencyEarned      Decimal   @default(0) @map("currency_earned") @db.Decimal(12, 4)

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@map("event_checkins")
}

// ============================================================
// TRANSACTIONS (Wallet Ledger)
// ============================================================

model Transaction {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  type          String   @db.VarChar(30) // event_earning, stock_buy, stock_sell, transfer, adjustment
  amount        Decimal  @db.Decimal(12, 4) // positive = credit, negative = debit
  balanceAfter  Decimal  @map("balance_after") @db.Decimal(12, 4)
  referenceType String?  @map("reference_type") @db.VarChar(30) // event, trade, etc.
  referenceId   String?  @map("reference_id")
  description   String?
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([type])
  @@index([referenceType, referenceId])
  @@map("transactions")
}
